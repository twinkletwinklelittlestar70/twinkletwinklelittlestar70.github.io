<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Fix error when Python class method called by a multi thread task · littlestar</title><meta name="description" content="Fix error when Python class method called by a multi thread task - Lin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="../../../../favicon.png"><link rel="stylesheet" href="../../../../css/hermes.css"><link rel="search" type="application/opensearchdescription+xml" href="https://twinkletwinklelittlestar70.github.io/atom.xml" title="littlestar"><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="atom.xml" title="littlestar" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="../../../../index.html"><img src="../../../../favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="../../../../index.html" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="../../../../https:/github.com/twinkletwinklelittlestar70" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="../../../../archives/" target="_self">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Fix error when Python class method called by a multi thread task</h1><div class="post-info">Oct 18, 2021</div><div class="post-content"><p>Here is the story. I am developing a python flask project today. And I need to provide an interface for the front end to run a model to recognize a set of facial images. </p>
<p>For a group of ten images, I first developed a single-threaded version to recognize, and the program took 2.4s in total. So I think, will there be optimization for multi-threading? I decided to use two threads and wrote the following code very quickly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, func, args=(<span class="params"></span>)</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(TaskThread, self).__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.result = self.func(*self.args)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_result</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">&#x27;[ERROR] in TaskThread &#x27;</span>, e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecogModel</span>():</span></span><br><span class="line">    <span class="comment"># ....</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Load the model</span></span><br><span class="line">        self.model = load_model()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predictImage</span> (<span class="params">self, filepath</span>):</span></span><br><span class="line">        <span class="comment"># ... model predict</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predict</span> (<span class="params">self, <span class="built_in">id</span>, is_multi_thread = <span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="comment"># ... get filepath</span></span><br><span class="line">        </span><br><span class="line">        work_task = TaskThread(self.predictImage, (filepath))</span><br><span class="line">        work_task.start()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ....</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>However I got error like this.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: method() takes 1 positional argument but 2 were given</span><br></pre></td></tr></table></figure>
<p>As we all know, the python class method feature is that when you call the internal method, you don’t need to manually pass the this pointer (self). When python is executed, it will add the first parameter <code>this</code> to the internal method by default. The code should be like this.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecogModel</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Load the model</span></span><br><span class="line">        self.model = load_model()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predictImage</span> (<span class="params">self, filepath</span>):</span></span><br><span class="line">        <span class="comment"># ... do model prediction</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predict</span> (<span class="params">self, <span class="built_in">id</span>, is_multi_thread = <span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="comment"># ... get filepath</span></span><br><span class="line">        </span><br><span class="line">        result = self.predictImage(filepath) <span class="comment"># no need to pass self</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ... do something</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>We can see that even though we only passed one parameter when calling the <code>self.predictImage</code> method. But in actual operation, python will add the self pointer to the <code>predictImage</code> method. This feature helps us reduce repetitive writing of “self” code, which is very convenient in most cases.</p>
<p>But when I delayed the class internal method to be called inside a thread class, the problem appeared. The code we actually call is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.result = self.func(*self.args)</span><br></pre></td></tr></table></figure>
<p>Due to our manual call, the python class cannot correctly bind the self parameter to our call.</p>
<p>The first solution I thought of was to curry the function that needs to be called and turn it into a static method that does not need to bind self. Code show as below.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecogModel</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Load the model</span></span><br><span class="line">        self.model = load_model()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predictImage</span> (<span class="params">model, filepath</span>):</span></span><br><span class="line">        <span class="comment"># ... do model prediction</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predict</span> (<span class="params">self, <span class="built_in">id</span>, is_multi_thread = <span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="comment"># ... get filepath</span></span><br><span class="line">        </span><br><span class="line">        result = self.predictImage(self.model, filepath)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ... do something</span></span><br></pre></td></tr></table></figure>
<p>This way can work, but I think it is not good  enough. A static method should be a tool method that is related to the class, but can be called without an instance of the class. Obviously this is not the case in our example. In our example, method <code>predictImage</code> needs a internal variable(the model). So method <code>predictImage</code> should be a member function.</p>
<p>In the end, my solution was very simple, using <code>__func__</code> in the python function object to get the original function and passing self manually. </p>
<p>My final code is as follows.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">work_task = ThreadClass.TaskThread(self.predictImageList.__func__, (self, file_list))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Finally, let’s take a look at the complete code.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, func, args=(<span class="params"></span>)</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(TaskThread, self).__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.result = self.func(*self.args)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_result</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">&#x27;[ERROR] in TaskThread &#x27;</span>, e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecogModel</span>():</span></span><br><span class="line">    <span class="comment"># ....</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Load the model</span></span><br><span class="line">        self.model = load_model()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predictImage</span> (<span class="params">self, filepath</span>):</span></span><br><span class="line">        <span class="comment"># ... model predict</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predict</span> (<span class="params">self, <span class="built_in">id</span>, is_multi_thread = <span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="comment"># ... get filepath</span></span><br><span class="line">        </span><br><span class="line">        work_task = ThreadClass.TaskThread(self.predictImageList.__func__, (self, file_list))</span><br><span class="line">        work_task.start()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ....</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>By the way, multithreading did not help me in time cost. The 2-thread version takes about 2.3 seconds, and the 10-thread version takes more than 4 seconds.</p>
<p>I guess life is always unsatisfactory, we can only accept it. Still hope this can help you :)</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="../../../12/20/mt-transformer/">PREV</a><a class="next" href="../../04/ml-stylegnn/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'true';
var disqus_identifier = '2021/10/18/py-classmth/';
var disqus_title = 'Fix error when Python class method called by a multi thread task';
var disqus_url = 'https://twinkletwinklelittlestar70.github.io/2021/10/18/py-classmth/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2019 - 2021 <a href="https://twinkletwinklelittlestar70.github.io">Lin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/claymcleod/hexo-theme-hermes" target="_blank">hexo-theme-hermes</a>. </p><p>Logo made by <a target="_blank" rel="noopener" href="https://www.flaticon.com/authors/freepik">Freepik</a> from <a target="_blank" rel="noopener" href="https://flaticon.com">www.flaticon.com</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-210509391-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-210509391-1');</script></body></html>